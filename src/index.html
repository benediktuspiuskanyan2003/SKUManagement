<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen SKU Produk</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Library untuk Scan Barcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover-color: #5a6268;
            --danger-color: #dc3545;
            --danger-hover-color: #c82333;
            --success-color: #28a745; /* Warna baru untuk tombol Scan */
            --success-hover-color: #218838;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --border-radius: 6px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #search-section, #results-section, #cart-section {
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            flex-wrap: wrap; /* Agar responsif di layar kecil */
            gap: 10px;
        }

        #search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            min-width: 200px; /* Lebar minimum untuk input */
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: var(--primary-color);
            color: white;
        }

        .btn:hover {
            background-color: var(--primary-hover-color);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-hover-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: var(--c82333);
        }

        .btn-success {
            background-color: var(--success-color);
        }
        .btn-success:hover {
            background-color: var(--success-hover-color);
        }

        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #results-table th, #results-table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        #results-table th {
            background-color: #f2f2f2;
        }

        .message-info, .message-error {
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            text-align: center;
        }
        .message-info {
            background-color: #e2f3ff;
            border: 1px solid #b6e0ff;
            color: #004085;
        }
        .message-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Form Styling */
        #product-form {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
            width: 100%;
            height: 40px;
        }
        
        .form-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input {
            padding-right: 35px; 
        }
        
        .clear-btn {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            border: none;
            background-color: transparent;
            width: 38px;
            height: 38px;
            cursor: pointer;
            font-size: 22px;
            color: #999;
            line-height: 38px;
            text-align: center;
        }

        .clear-btn:hover {
            color: #333;
        }

        /* --- STYLE BARU UNTUK SCANNER --- */
        #scanner-container {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: #fff;
        }
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #scanner-container .scanner-buttons {
            text-align: center;
            margin-top: 15px;
        }
        /* ------------------------------- */

    </style>
</head>
<body>
    <div class="container">
        <h1>Manajemen SKU</h1>
        
        <!-- Kontainer untuk scanner, awalnya disembunyikan -->
        <div id="scanner-container" style="display:none;">
            <div id="qr-reader"></div>
            <div class="scanner-buttons">
                <button class="btn btn-danger" onclick="stopScanner()">Tutup Scanner</button>
            </div>
        </div>

        <!-- Konten utama aplikasi -->
        <div id="main-content">
            <div id="search-section">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Cari SKU / Nama atau Scan Barcode...">
                    <!-- TOMBOL BARU DITAMBAHKAN -->
                    <button class="btn btn-success" onclick="startScanner()">Scan</button>
                    <button class="btn" onclick="searchProduct()">Cari</button>
                    <button class="btn btn-secondary" onclick="showAddProductForm()">Tambah Manual</button>
                </div>
            </div>
            
            <div id="results-section">
                <!-- Hasil pencarian atau form tambah/edit akan muncul di sini -->
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('search-input');
        const resultsDiv = document.getElementById('results-section');
        const mainContent = document.getElementById('main-content');
        const scannerContainer = document.getElementById('scanner-container');
        
        let editingSku = null;
        let html5QrCode = null; // Variabel global untuk instance scanner

        // --- LOGIKA BARU UNTUK SCANNER KAMERA ---
        function startScanner() {
            mainContent.style.display = 'none';
            scannerContainer.style.display = 'block';
            resultsDiv.innerHTML = ''; // Bersihkan hasil sebelumnya

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                stopScanner();
                searchInput.value = decodedText; // Masukkan hasil scan ke input
                searchProduct(); // Jalankan pencarian AI/biasa
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // Coba mulai scanner
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => {
                    console.error("Gagal memulai scanner", err);
                    alert("Gagal memulai scanner. Pastikan Anda memberikan izin kamera.");
                    stopScanner();
                });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => {
                    console.error("Gagal menghentikan scanner dengan benar.", err);
                });
            }
            mainContent.style.display = 'block';
            scannerContainer.style.display = 'none';
        }
        // ----------------------------------------

        function clearInput(inputId) {
            const inputElement = document.getElementById(inputId);
            if(inputElement) {
                inputElement.value = '';
                inputElement.focus();
            }
        }

        function showSearch() {
            editingSku = null;
            searchInput.value = '';
            resultsDiv.innerHTML = '';
            mainContent.style.display = 'block';
            scannerContainer.style.display = 'none';
        }

        async function searchProduct() {
            const query = searchInput.value.trim();
            if (!query) return;

            if (/^\d{8,}$/.test(query)) { // Sedikit dilonggarkan untuk berbagai jenis barcode
                resultsDiv.innerHTML = `<p style="text-align:center;">ðŸ¤– Mencari data dengan AI untuk barcode ${query}, mohon tunggu...</p>`;
                
                try {
                    const response = await fetch(`/api/enrich_with_ai?sku=${encodeURIComponent(query)}`);
                    const result = await response.json();
    
                    if (!response.ok) {
                        throw new Error(result.error || 'Gagal mengambil data dari AI.');
                    }
    
                    showAddProductForm(result);
    
                } catch (error) {
                    resultsDiv.innerHTML = `<p class="message-error" style="text-align:center;">Error: ${error.message}</p>
                    <div class="form-buttons" style="justify-content: center;">
                        <button class="btn btn-secondary" onclick="showAddProductForm({ SKU: query })">Coba Isi Manual Saja</button>
                    </div>`;
                }
            } else {
                 try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const products = await response.json();
                    displayResults(products);
                } catch (error) {
                    resultsDiv.innerHTML = `<p class="message-error">Gagal mengambil data. Coba lagi nanti.</p>`;
                }
            }
        }

        function displayResults(products) {
            if (products.length === 0) {
                resultsDiv.innerHTML = `<p class="message-info">Tidak ada produk yang cocok ditemukan.</p>`;
                return;
            }

            let table = `<table id="results-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Nama Produk</th>
                        <th>Kategori</th>
                        <th>Merek</th>
                        <th>Harga</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>`;
            
            products.forEach(p => {
                table += `
                    <tr>
                        <td>${p.SKU}</td>
                        <td>${p.ITEMS_NAME}</td>
                        <td>${p.CATEGORY}</td>
                        <td>${p.BRAND_NAME}</td>
                        <td>${p.PRICE ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(p.PRICE) : ''}</td>
                        <td><button class="btn btn-secondary" onclick='editProduct(${JSON.stringify(p)})'>Edit</button></td>
                    </tr>`;
            });

            table += `</tbody></table>`;
            resultsDiv.innerHTML = table;
        }

        function editProduct(product) {
            editingSku = product.SKU;
            showAddProductForm(product);
        }
        
        function showAddProductForm(product = {}) {
            const isUpdate = product && product.SKU && editingSku;
            const skuValue = product?.SKU || searchInput.value.match(/^\d+$/) ? searchInput.value : '';

            function createInput(id, label, value = '', disabled = false) {
                 const finalValue = (value === null || value === undefined) ? '' : value;
                 if (disabled) {
                     return `
                        <div class="form-group">
                            <label for="${id}">${label}</label>
                            <input type="text" id="${id}" value="${finalValue}" disabled>
                        </div>
                     `;
                 }
                 return `
                    <div class="form-group">
                        <label for="${id}">${label}</label>
                        <div class="input-wrapper">
                            <input type="${id === 'PRICE' ? 'number' : 'text'}" id="${id}" value="${finalValue}">
                            <button class="clear-btn" onclick="clearInput('${id}')" type="button">&times;</button>
                        </div>
                    </div>
                 `;
            }

            resultsDiv.innerHTML = `
                <div id="product-form">
                    <h3>${isUpdate ? 'Edit Produk' : 'Tambah Produk Baru'}</h3>
                    <div class="form-grid">
                        ${createInput('SKU', 'SKU / Barcode', product?.SKU || skuValue, isUpdate)}
                        ${createInput('ITEMS_NAME', 'Nama Produk', product?.ITEMS_NAME)}
                        ${createInput('CATEGORY', 'Kategori', product?.CATEGORY)}
                        ${createInput('BRAND_NAME', 'Merek', product?.BRAND_NAME)}
                        ${createInput('VARIANT_NAME', 'Varian', product?.VARIANT_NAME)}
                        ${createInput('PRICE', 'Harga', product?.PRICE)}
                    </div>
                    <div class="form-buttons">
                        <button class="btn" onclick="${isUpdate ? `submitUpdate('${product.SKU}')` : 'submitProduct()'}">${isUpdate ? 'Simpan Perubahan' : 'Simpan Produk'}</button>
                        <button class="btn btn-secondary" onclick="showSearch()">Batal</button>
                    </div>
                </div>
            `;
            document.getElementById('search-input').value = '';
        }

        async function submitProduct() {
            const productData = {
                SKU: document.getElementById('SKU').value,
                ITEMS_NAME: document.getElementById('ITEMS_NAME').value,
                CATEGORY: document.getElementById('CATEGORY').value,
                BRAND_NAME: document.getElementById('BRAND_NAME').value,
                VARIANT_NAME: document.getElementById('VARIANT_NAME').value,
                PRICE: document.getElementById('PRICE').value,
            };

            try {
                const response = await fetch('/api/add_product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Gagal menyimpan data.');

                alert('Produk berhasil ditambahkan!');
                showSearch();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function submitUpdate(sku) {
             const productData = {
                SKU: sku,
                ITEMS_NAME: document.getElementById('ITEMS_NAME').value,
                CATEGORY: document.getElementById('CATEGORY').value,
                BRAND_NAME: document.getElementById('BRAND_NAME').value,
                VARIANT_NAME: document.getElementById('VARIANT_NAME').value,
                PRICE: document.getElementById('PRICE').value,
            };

            try {
                const response = await fetch('/api/update_product', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Gagal memperbarui data.');

                alert('Produk berhasil diperbarui!');
                showSearch();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchProduct();
            }
        });

        // Initial state
        showSearch();
    </script>
</body>
</html>
